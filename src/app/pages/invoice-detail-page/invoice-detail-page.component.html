<ngx-spinner bdColor="rgba(0, 0, 0, 0.8)" size="large" color="#001c71" type="ball-scale-multiple" [fullScreen]="true">
  <p style="color: #f5ae1c"> Cargando... </p>
</ngx-spinner>

<!-- ====== HEADER consistente con las otras pantallas ====== -->
<div class="flex items-center justify-between bg-white rounded-md border px-4 py-3 mb-3 shadow-sm">
  <div class="flex items-center gap-3">
    <button class="btn btn-ghost px-2 py-1" (click)="goBack()" aria-label="Volver a Facturas">
      <fa-icon icon="arrow-left"></fa-icon>
      <span class="hidden sm:inline ml-2">Atrás</span>
    </button>

    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-base sm:text-lg font-semibold tracking-wide">
          Factura <span class="text-muted-foreground">#{{ invoice?.sri?.number || '—' }}</span>
        </h1>
        <span class="badge" [ngClass]="{
              'badge-green': invoice?.status === 'AUTORIZADO',
              'badge-red': invoice?.status === 'Rejected' || invoice?.status === 'ERROR' || invoice?.status === 'ANULADA',
              'badge-yellow': invoice?.status !== 'AUTORIZADO'
                                && invoice?.status !== 'Rejected'
                                && invoice?.status !== 'ERROR'
            }">
          {{ invoice?.status }}
        </span>
      </div>

      <div class="text-[11px] text-gray-500 flex gap-3 flex-wrap mt-1">
        <span *ngIf="invoice?.createdAt">Emisión: <b>{{ invoice?.createdAt | ecuadorTime }}</b></span>
        <span *ngIf="invoice?.total">Total: <b class="text-green-700">{{ invoice?.total | currency:'USD':'symbol':'1.2-2' }}</b></span>
      </div>
    </div>
  </div>

  <!-- Acciones rápidas (desktop) -->
  <div class="hidden md:flex items-center gap-2">
    <button class="btn btn-warn"
            (click)="openMotivo()"
            [disabled]="invoice?.status !== 'AUTORIZADO'"
            [title]="invoice?.status !== 'AUTORIZADO' ? 'Solo puedes anular facturas autorizadas' : ''">
      Anular
    </button>
    <button *ngIf="invoice?.sri?.status != 'AUTORIZADO'" class="btn btn-warn" (click)="reenviarFactura()">
      Reenviar
    </button>
    <button *ngIf="invoice?.type !== 'Nota Venta'" class="btn btn-primary" (click)="getFacturaPdf()">
      <fa-icon [icon]="['fas','download']" class="mr-1"></fa-icon>Descargar Factura
    </button>
  </div>
</div>

<!-- ====== LAYOUT EN 2 COLUMNAS ====== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">

  <!-- ===== Columna principal (información + productos) ===== -->
  <div class="md:col-span-2 space-y-6">

    <!-- Información del Cliente -->
    <section class="bg-white rounded-md border shadow-sm p-5">
      <div class="flex items-center justify-between ">
        <h3 class="text-[13px] font-semibold text-gray-700">INFORMACIÓN DEL CLIENTE</h3>
      </div>
      <ul class="text-sm text-gray-700 grid sm:grid-cols-2 gap-y-2 gap-x-6">
        <li><strong>Nombre:</strong> {{ invoice?.customer?.fullName || '—' }}</li>
        <li><strong>Cédula/RUC:</strong> {{ invoice?.customer?.num_identificacion || '—' }}</li>
        <li><strong>Email:</strong> {{ invoice?.customer?.correo || '—' }}</li>
        <li><strong>Teléfono:</strong> {{ invoice?.customer?.telefono || '—' }}</li>
        <li class="sm:col-span-2"><strong>Dirección:</strong> {{ invoice?.customer?.direccion || '—' }}</li>
      </ul>
    </section>

    <!-- Información del SRI -->
    <section class="bg-white rounded-md border shadow-sm p-5">
      <div class="flex items-center justify-between ">
        <h3 class="text-[13px] font-semibold text-gray-700">INFORMACIÓN DEL SRI</h3>
        <span class="badge" [ngClass]="{
              'badge-green': invoice?.sri?.status === 'AUTORIZADO',
              'badge-red': invoice?.sri?.status === 'Rejected' || invoice?.sri?.status === 'ERROR',
              'badge-yellow': invoice?.sri?.status !== 'AUTORIZADO'
                                && invoice?.sri?.status !== 'Rejected'
                                && invoice?.sri?.status !== 'ERROR'
            }">
          {{ sriStatus }}
        </span>
      </div>
      <ul class="text-sm text-gray-700 grid sm:grid-cols-2 gap-y-2 gap-x-6">
        <li><strong>Estado SRI:</strong> {{ sriStatus }}</li>
        <li *ngIf="invoice?.sri?.number"><strong>N°:</strong> {{ invoice?.sri?.number }}</li>
        <li *ngIf="invoice?.sri?.invoice"><strong>Factura:</strong> {{ invoice?.sri?.invoice }}</li>
        <li *ngIf="invoice?.sri?.authorization_datetime" class="sm:col-span-2">
          <strong>Fecha Autorización:</strong> {{ invoice?.sri?.authorization_datetime }}
        </li>
        <li *ngIf="invoice?.sri?.sri_message" class="sm:col-span-2">
          <strong>Mensaje SRI:</strong> {{ invoice?.sri?.sri_message }}
        </li>
      </ul>
    </section>

    <!-- Productos -->
    <section class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Productos de la Factura</h2>

      <div class="overflow-x-auto max-h-[60vh] overflow-y-auto border border-gray-200 rounded-md">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-gray-50 sticky top-0 z-10">
            <tr>
              <th class="p-3 text-left">Producto</th>
              <th class="p-3 text-left">Cantidad</th>
              <th class="p-3 text-left">Precio Unit.</th>
              <th class="p-3 text-left">IVA</th>
              <th class="p-3 text-left">Subtotal</th>
              <th class="p-3 text-left">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of invoice?.items" class="border-t hover:bg-gray-50">
              <td class="p-3">{{ item.productName }}</td>
              <td class="p-3">{{ item.quantity }}</td>
              <td class="p-3">{{ item.price | currency:'USD':'symbol':'1.2-2' }}</td>
              <td class="p-3">{{ item.tax_rate }}%</td>
              <td class="p-3">
                {{ (item.subtotal ?? (item.quantity * item.price)) | currency:'USD':'symbol':'1.2-2' }}
              </td>
              <td class="p-3 font-medium">
                {{
                  (item.total ??
                    ((item.subtotal ?? (item.quantity * item.price)) +
                     ((item.subtotal ?? (item.quantity * item.price)) * ((item.tax_rate ?? 0)/100)))
                  ) | currency:'USD':'symbol':'1.2-2'
                }}
              </td>
            </tr>
            <tr *ngIf="!invoice?.items?.length">
              <td colspan="6" class="p-4 text-center text-muted-foreground">No hay productos en esta factura.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- ===== Columna lateral (resumen + acciones) ===== -->
  <aside class="md:col-span-1">
    <div class="space-y-4 md:sticky md:top-6">

      <!-- Resumen -->
      <section class="bg-white rounded-md border shadow-sm p-5">
        <h3 class="text-[13px] font-semibold text-gray-700 ">RESUMEN</h3>
        <div class="space-y-1 text-gray-700">
          <div class="flex justify-between">
            <span class="text-xs">Subtotal:</span>
            <span class="font-medium">{{ invoice?.subtotal | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-xs">IVA:</span>
            <span class="font-medium">{{ invoice?.iva | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="flex justify-between items-center font-bold text-base pt-2 border-t mt-2">
            <span>Total:</span>
            <span>{{ invoice?.total | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </section>

      <!-- Acciones -->
      <section class="bg-white rounded-md border shadow-sm p-5">
        <div class="flex flex-col gap-2">
          <button class="btn btn-warn"
                  (click)="openMotivo()"
                  [disabled]="invoice?.status !== 'AUTORIZADO'"
                  [title]="invoice?.status !== 'AUTORIZADO' ? 'Solo puedes anular facturas autorizadas' : ''">
            Anular
          </button>

          <button *ngIf="invoice?.sri?.status != 'AUTORIZADO'" class="btn btn-warn" (click)="reenviarFactura()">
            Reenviar
          </button>

          <button *ngIf="invoice?.type !== 'Nota Venta'" class="btn btn-primary" (click)="getFacturaPdf()">
            <fa-icon [icon]="['fas','download']" class="mr-1"></fa-icon> Descargar Factura
          </button>
        </div>
      </section>

    </div>
  </aside>
</div>

<!-- ===== Barra de acciones móvil ===== -->
<div class="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white border-t px-4 py-2 flex gap-2 justify-center">
  <button *ngIf="invoice?.sri?.status != 'AUTORIZADO'" class="btn btn-warn" (click)="reenviarFactura()">
    Reenviar
  </button>
  <button *ngIf="invoice?.type !== 'Nota Venta'" class="btn btn-primary" (click)="getFacturaPdf()">
    <fa-icon [icon]="['fas','download']" class="mr-1"></fa-icon>Factura
  </button>
</div>

<!-- ===== Modal de Motivo (se mantiene tu lógica y bindings) ===== -->
<div *ngIf="showMotivoModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded shadow-lg p-4 text-xs relative">
    <button class="absolute top-2 right-3 text-lg" (click)="closeMotivo()">×</button>

    <h3 class="text-base font-semibold mb-1 text-center">Motivo de la factura</h3>
    <p class="text-gray-500 text-sm text-center mb-3">Elige un motivo o especifica uno nuevo</p>

    <form [formGroup]="motivoForm" (ngSubmit)="onConfirmMotivo()" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Motivo</label>
        <select formControlName="motivo" (change)="onMotivoChange()"
                class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
          <option value="" disabled selected>Elige una opción</option>
          <option *ngFor="let m of motivosAnulacion" [value]="m">{{ m }}</option>
        </select>
        <div *ngIf="motivoForm.get('motivo')?.invalid && motivoForm.get('motivo')?.touched" class="text-red-500 text-xs mt-1">
          Debes elegir un motivo.
        </div>
      </div>

      <div *ngIf="motivoForm.value.motivo === 'Otro'">
        <label class="block text-sm font-medium mb-1">Especifica el motivo</label>
        <input type="text" formControlName="otroTexto"
               class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
               placeholder="Escribe aquí…" />
        <div *ngIf="motivoForm.get('otroTexto')?.invalid && motivoForm.get('otroTexto')?.touched" class="text-red-500 text-xs mt-1">
          Escribe al menos 2 caracteres.
        </div>
      </div>

      <div class="pt-2 flex items-center justify-center gap-2">
        <button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:opacity-90">Aceptar</button>
        <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" (click)="closeMotivo()">Cancelar</button>
      </div>
    </form>
  </div>
</div>
