<header class="sticky top-0 bg-white/90 backdrop-blur border-b">
  <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <button class="btn btn-ghost px-2 py-1" (click)="goBack()" aria-label="Volver a Facturas">
        <fa-icon icon="arrow-left"></fa-icon>
        <span class="hidden sm:inline ml-2">AtrÃ¡s</span>
      </button>

      <div>
        <div class="flex items-center gap-3">
          <h1 class="text-xl sm:text-2xl font-semibold">
            Factura <span class="text-muted-foreground">#{{ invoice?.sri?.number || 'â€”' }}</span>
          </h1>
          <span class="badge"
                [ngClass]="{
                  'badge-green': invoice?.sri?.status === 'AUTORIZADO',
                  'badge-red': invoice?.sri?.status === 'Rejected' || invoice?.sri?.status === 'ERROR',
                  'badge-yellow': invoice?.sri?.status !== 'AUTORIZADO'
                                    && invoice?.sri?.status !== 'Rejected'
                                    && invoice?.sri?.status !== 'ERROR'
                }">
            {{ sriStatus }}
          </span>
        </div>

        <!-- <div class="text-sm text-muted-foreground flex gap-3 flex-wrap mt-1">
         
          <span>Fecha: <b>{{ invoice?.createdAt | ecuadorTime }}</b></span>
          <span>Total: <b class="text-green-700">{{ invoice?.total | currency:'USD':'symbol':'1.2-2' }}</b></span>
        </div> -->
      </div>
    </div>

    <!-- Acciones rÃ¡pidas (solo desktop) -->
    <div class="hidden md:flex items-center gap-2">
      <button *ngIf="invoice?.sri?.status === 'AUTORIZADO'"  class="btn btn-warn" (click)="openMotivo()"> Anular</button>
      <button *ngIf="invoice?.sri?.status != 'AUTORIZADO'"  class="btn btn-warn" (click)="reenviarFactura()">  Reenviar</button>
      <button *ngIf="invoice?.type !== 'Nota Venta'" class="btn btn-primary" (click)="getFacturaPdf()">  <fa-icon [icon]="['fas','download']" class="mr-1"></fa-icon>Descargar Factura</button>
        
    </div>
  </div>
</header>

<!-- CONTENIDO: 2 columnas -->
<!-- CONTENIDO: prioridad a Cliente y SRI, luego Resumen, luego Productos -->
<main class="max-w-screen-xl mx-auto px-6 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- FILA 1: Cliente + SRI (prioridad visual) -->
  <section class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- InformaciÃ³n del Cliente -->
    <div class="app-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-700">ðŸ‘¤ InformaciÃ³n del Cliente</h3>
        <!-- <span *ngIf="invoice?.customer?.fullName" class="badge badge-outline">
          {{ invoice?.customer?.fullName }}
        </span> -->
      </div>
      <ul class="text-sm text-gray-700 grid sm:grid-cols-2 gap-y-2 gap-x-6">
        <li><strong>Nombre:</strong> {{ invoice?.customer?.fullName || 'â€”' }}</li>
        <li><strong>CÃ©dula/RUC:</strong> {{ invoice?.customer?.num_identificacion || 'â€”' }}</li>
        <li><strong>Email:</strong> {{ invoice?.customer?.correo || 'â€”' }}</li>
        <li><strong>TelÃ©fono:</strong> {{ invoice?.customer?.telefono || 'â€”' }}</li>
        <li class="sm:col-span-2"><strong>DirecciÃ³n:</strong> {{ invoice?.customer?.direccion || 'â€”' }}</li>
      </ul>
    </div>

    <!-- InformaciÃ³n del SRI -->
    <div class="app-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-700">ðŸ“¤ InformaciÃ³n del SRI</h3>
        <span class="badge"
              [ngClass]="{
                'badge-green': invoice?.sri?.status === 'AUTORIZADO',
                'badge-red': invoice?.sri?.status === 'Rejected' || invoice?.sri?.status === 'ERROR',
                'badge-yellow': invoice?.sri?.status !== 'AUTORIZADO'
                                  && invoice?.sri?.status !== 'Rejected'
                                  && invoice?.sri?.status !== 'ERROR'
              }">
          {{ sriStatus }}
        </span>
      </div>
      <ul class="text-sm text-gray-700 grid sm:grid-cols-2 gap-y-2 gap-x-6">
        <li><strong>Estado SRI:</strong> {{ sriStatus }}</li>
        <li *ngIf="invoice?.sri?.number"><strong>NÂ°:</strong> {{ invoice?.sri?.number }}</li>
        <li *ngIf="invoice?.sri?.invoice"><strong>Factura:</strong> {{ invoice?.sri?.invoice }}</li>
        <li *ngIf="invoice?.sri?.authorization_datetime" class="sm:col-span-2">
          <strong>Fecha AutorizaciÃ³n:</strong> {{ invoice?.sri?.authorization_datetime }}
        </li>
        <!-- <li class="sm:col-span-2 text-muted-foreground">
         
          <span class="mx-2">â€¢</span>
          <span>Fecha: <b>{{ invoice?.createdAt | ecuadorTime }}</b></span>
          <span class="mx-2">â€¢</span>
          <span>Total: <b class="text-green-700">{{ invoice?.total | currency:'USD':'symbol':'1.2-2' }}</b></span>
        </li> -->
         <li *ngIf="invoice?.sri?.sri_message" class="sm:col-span-2 ">
          <strong>Mensaje SRI:</strong> {{ invoice?.sri?.sri_message }}
        </li>
      </ul>
    </div>
  </section>

  <!-- FILA 2: Resumen (compacto) -->
  <section class="lg:col-span-3">
    <div class="app-card p-6">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ðŸ§¾ Resumen de la Factura</h3>
      <div class="grid sm:grid-cols-3 gap-4">
        <div>
          <div class="text-sm text-muted-foreground">Subtotal</div>
          <div class="font-medium text-gray-900">
            {{ invoice?.subtotal | currency:'USD':'symbol':'1.2-2' }}
          </div>
        </div>
        <div>
          <div class="text-sm text-muted-foreground">IVA</div>
          <div class="font-medium text-gray-900">
            {{ invoice?.iva | currency:'USD':'symbol':'1.2-2' }}
          </div>
        </div>
        <div>
          <div class="text-sm text-muted-foreground">Total</div>
          <div class="font-semibold text-green-700">
            {{ invoice?.total | currency:'USD':'symbol':'1.2-2' }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FILA 3: Productos (a ancho completo) -->
  <section class="lg:col-span-3">
    <div class="app-card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-700">ðŸ“¦ Productos de la Factura</h3>
      </div>

      <div class="overflow-x-auto max-h-[60vh] overflow-y-auto border border-gray-200 rounded-md">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-gray-50 sticky top-0 z-10">
            <tr>
              <th class="p-3 text-left">Producto</th>
              <th class="p-3 text-left">Cantidad</th>
              <th class="p-3 text-left">Precio Unit.</th>
              <th class="p-3 text-left">IVA</th>
              <th class="p-3 text-left">Subtotal</th>
              <th class="p-3 text-left">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of invoice?.items" class="border-t hover:bg-gray-50">
              <td class="p-3">{{ item.productName }}</td>
              <td class="p-3">{{ item.quantity }}</td>
              <td class="p-3">{{ item.price | currency:'USD':'symbol':'1.2-2' }}</td>
              <td class="p-3">{{ item.tax_rate }}%</td>
              <td class="p-3">
                {{ (item.subtotal ?? (item.quantity * item.price)) | currency:'USD':'symbol':'1.2-2' }}
              </td>
              <td class="p-3 font-medium">
                {{
                  (item.total ??
                    ((item.subtotal ?? (item.quantity * item.price)) +
                     ((item.subtotal ?? (item.quantity * item.price)) * ((item.tax_rate ?? 0)/100)))
                  ) | currency:'USD':'symbol':'1.2-2'
                }}
              </td>
            </tr>
            <tr *ngIf="!invoice?.items?.length">
              <td colspan="6" class="p-4 text-center text-muted-foreground">
                No hay productos en esta factura.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Acciones rÃ¡pidas (desktop) -->

    </div>
  </section>
</main>

<!-- Barra de acciones mÃ³vil (fija en el pie de la pÃ¡gina) -->
<div class="md:hidden fixed bottom-0 inset-x-0 z-40 bg-white border-t px-4 py-2 flex gap-2 text-center text-flex align-items-center justify-center">
   <button *ngIf="invoice?.sri?.status != 'AUTORIZADO'"  class="btn btn-warn" (click)="reenviarFactura()">  Reenviar</button>
      <button *ngIf="invoice?.type !== 'Nota Venta'" class="btn btn-primary" (click)="getFacturaPdf()">  <fa-icon [icon]="['fas','download']" class="mr-1"></fa-icon>Factura</button>
</div>


<!-- ===== MODAL DE MOTIVO (igual estilo que tu modal de cliente) ===== -->
<div *ngIf="showMotivoModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded shadow-lg p-4 text-xs relative">
    <button class="absolute top-2 right-3 text-lg" (click)="closeMotivo()">Ã—</button>

    <h3 class="text-base font-semibold mb-1 text-center">Motivo de la factura</h3>
    <p class="text-gray-500 text-sm text-center mb-3">
      Elige un motivo o especifica uno nuevo
    </p>

    <form [formGroup]="motivoForm" (ngSubmit)="onConfirmMotivo()" class="space-y-4">
      <!-- Select de motivos -->
      <div>
        <label class="block text-sm font-medium mb-1">Motivo</label>
        <select formControlName="motivo"
                (change)="onMotivoChange()"
                class="w-full border rounded px-3 py-2 text-sm
                       focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
          <option value="" disabled selected>Elige una opciÃ³n</option>
          <option *ngFor="let m of motivosAnulacion" [value]="m">{{ m }}</option>
        </select>
        <div *ngIf="motivoForm.get('motivo')?.invalid && motivoForm.get('motivo')?.touched"
             class="text-red-500 text-xs mt-1">
          Debes elegir un motivo.
        </div>
      </div>

      <!-- Input cuando elige "Otro" -->
      <div *ngIf="motivoForm.value.motivo === 'Otro'">
        <label class="block text-sm font-medium mb-1">Especifica el motivo</label>
        <input type="text" formControlName="otroTexto"
               class="w-full border rounded px-3 py-2 text-sm
                      focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
               placeholder="Escribe aquÃ­â€¦" />
        <div *ngIf="motivoForm.get('otroTexto')?.invalid && motivoForm.get('otroTexto')?.touched"
             class="text-red-500 text-xs mt-1">
          Escribe al menos 2 caracteres.
        </div>
      </div>

      <!-- Acciones -->
      <div class="pt-2 flex items-center justify-center gap-2">
        <button type="submit"
                class="bg-primary text-white px-4 py-2 rounded hover:opacity-90">
          Aceptar
        </button>
        <button type="button"
                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                (click)="closeMotivo()">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>