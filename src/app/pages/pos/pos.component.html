<!-- CONTENEDOR PRINCIPAL -->
<div class=" bg-background flex flex-col">
    <div class="container mx-auto px-4 py-4 flex-grow flex flex-col">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-grow">


            <!-- PRODUCTOS -->
            <div class="col-span-2 flex flex-col  overflow-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Columna 1: Cliente -->
                    <div>
                        <h2 class="text-lg font-semibold text-primary mb-2">Cliente</h2>

                        <div class="flex items-center gap-2 mb-2">
                            <input type="text" maxlength="10" appOnlyNumbers [(ngModel)]="identificationCustomer"
                                placeholder="Ingrese el número de cédula"
                                class="rounded  px-3 py-1 text-xs disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed"
                                [disabled]="customer" />



                            <button (click)="findByIdentificationCustomer()"
                                class="bg-primary text-white text-xs px-2 py-1 rounded hover:bg-primary/90 transition"
                                title="Buscar cliente">
                                <fa-icon icon="search"></fa-icon>
                            </button>

                            <button (click)="identificationCustomer = '' ; customer = null"
                                class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600 transition"
                                title="Limpiar">
                                <fa-icon icon="times"></fa-icon>
                            </button>
                        </div>

                        <div class="text-xs text-muted-foreground space-y-0.5">
                            <p>{{ customer?.nombre }}</p>
                            <p>{{ customer?.correo }}</p>
                        </div>
                    </div>

                    <!-- Columna 2: Acciones rápidas -->
                    <div class="flex gap-2 items-start md:justify-end">
                        <button (click)="showCustomerModal = true"
                            class="bg-primary text-white text-xs px-3 py-1 rounded hover:bg-primary/90 transition"
                            title="Nuevo cliente">
                            <fa-icon icon="user-plus"></fa-icon>
                        </button>

                        <button class="bg-primary text-white text-xs px-3 py-1 rounded hover:bg-primary/90 transition"
                            (click)="selectFinalConsumer()">
                            Consumidor Final
                        </button>
                    </div>
                </div>



                <!-- <input type="text" placeholder="Buscar productos..." [(ngModel)]="searchTerm"
                    class="w-1/2 rounded border px-3 py-1 text-xs" /> -->
                <div class="overflow-x-auto whitespace-nowrap py-2">
                    <h2 class="text-lg font-semibold text-primary">Productos</h2>

                    <div class="inline-flex gap-2">
                        <button (click)="onCategorySelected('')" [class.bg-primary]="selectedCategory === ''"
                            class="text-xs px-3 py-1 border rounded hover:bg-primary hover:text-white transition shrink-0">
                            Todos
                        </button>
                        <button *ngFor="let category of categories" (click)="onCategorySelected(category.name)"
                            [class.bg-primary]="selectedCategory === category.name"
                            class="text-xs px-3 py-1 border rounded hover:bg-primary hover:text-white transition shrink-0">
                            {{ category.nombre }}
                        </button>

                    </div>
                </div>




                <div class="max-h-[50vh] overflow-y-auto">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-3 pb-5">
                        <div *ngFor="let product of filteredProductList" (click)="addProduct(product)"
                            class="cursor-pointer rounded border p-2 shadow-sm hover:bg-muted transition text-xs">
                            <h3 class="font-medium text-foreground">{{ product.nombre }}</h3>
                            <p class="text-muted-foreground">
                                <span>{{ product.descripcion ? '(' + product.descripcion + ')' : '' }}</span>
                            </p>
                            <p class="text-muted-foreground text-lg">${{ product.precio | number: '1.2-2' }}</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RESUMEN DEL PEDIDO -->
            <div class="flex flex-col  h-full overflow-auto text-xs">
                <h2 class="text-lg font-semibold text-primary">Resumen</h2>

                <ng-container *ngIf="cart.length > 0; else emptyCart">
                    <div class="flex-grow overflow-auto space-y-1 max-h-[50vh] overflow-y-auto">
                        <div *ngFor="let item of cart" class="flex justify-between items-center border-b py-1 ">
                            <span class="font-medium text-foreground">
                                {{ item.nombre }} {{ item.descripcion ? '(' + item.descripcion + ')' : '' }} <span class="text-foreground font-normal">x{{ item.quantity }}</span>
                            </span>
                            <div class="flex items-center gap-2">
                                <button (click)="decrease(item)"
                                    class="w-6 h-6 rounded-full border text-foreground hover:bg-gray-100 flex items-center justify-center"
                                    title="Disminuir cantidad">
                                    <fa-icon icon="minus"></fa-icon>
                                </button>
                                <span class="w-5 text-center font-semibold">{{ item.quantity }}</span>
                                <button (click)="increase(item)"
                                    class="w-6 h-6 rounded-full border text-foreground hover:bg-gray-100 flex items-center justify-center"
                                    title="Aumentar cantidad">
                                    <fa-icon icon="plus"></fa-icon>
                                </button>

                                <strong class="ml-2 text-foreground">${{ item.total | number: '1.2-2' }}</strong>
                            </div>
                        </div>
                    </div>


                    <!-- TOTALES -->
                    <div class="border-t pt-4 space-y-1 text-xs text-foreground">
                        <p>Subtotal: ${{ subtotal | number: '1.2-2' }}</p>
                        <p>IVA (15%): ${{ iva | number: '1.2-2' }}</p>
                        <p class="text-base font-bold">Total: ${{ total | number: '1.2-2' }}</p>
                    </div>


                    <!-- BOTONES -->
                    <!-- BOTONES -->
                    <div class="space-y-2">
                        <button (click)="abrirModalPago()"
                            class="w-full rounded bg-primary px-4 py-2 text-white font-semibold hover:bg-primary/90 text-sm">
                            Crear Orden
                        </button>
                    </div>

                </ng-container>

                <ng-template #emptyCart>
                    <p class="text-xs text-muted-foreground">Aún no hay productos en la venta.</p>
                </ng-template>

            </div>

        </div>
    </div>
</div>

<!-- MODAL DE NUEVO CLIENTE -->
<div *ngIf="showCustomerModal" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
    <div class="bg-white w-full max-w-md rounded shadow-lg p-4 text-xs relative">
        <button class="absolute top-2 right-3 text-lg" (click)="showCustomerModal = false">×</button>
        <h3 class="text-base font-semibold mb-2">Nuevo Cliente</h3>

        <form [formGroup]="clienteForm" (ngSubmit)="guardarCliente()" class="space-y-4">
            <!-- Nombre / Razón Social -->
            <div>
                <label class="block text-sm font-medium">Nombre / Razón Social</label>
                <input type="text" formControlName="nombre" class="w-full border rounded px-3 py-2 text-sm" />
                <div *ngIf="f['nombre'].invalid && submitted" class="text-red-500 text-sm">
                    Campo requerido.
                </div>
            </div>

            <!-- Tipo -->
            <div>
                <label class="block text-sm font-medium">Tipo</label>
                <select formControlName="tipo_identificacion" class="w-full border rounded px-3 py-2 text-sm">
                    <option value="06 - Consumidor Final">Consumidor Final</option>
                    <option value="04 - Cédula">Cédula</option>
                    <option value="05 - RUC">RUC</option>
                </select>
                <div *ngIf="f['tipo_identificacion'].invalid && submitted" class="text-red-500 text-sm">
                    Seleccione un tipo válido.
                </div>
            </div>

            <!-- Identificación -->
            <div>
                <label class="block text-sm font-medium">Identificación</label>
                <input maxlength="13" type="text" formControlName="num_identificacion"
                    class="w-full border rounded px-3 py-2 text-sm" />
                <div *ngIf="f['num_identificacion'].invalid && submitted" class="text-red-500 text-sm">
                    Campo requerido.
                </div>
            </div>


            <!-- Email -->
            <div>
                <label class="block text-sm font-medium">Email</label>
                <input type="email" formControlName="correo" class="w-full border rounded px-3 py-2 text-sm" />
                <div *ngIf="f['correo'].invalid && submitted" class="text-red-500 text-sm">
                    Email inválido.
                </div>
            </div>

            <!-- Teléfono -->
            <div>
                <label class="block text-sm font-medium">Teléfono</label>
                <input maxlength="10" type="text" formControlName="telefono"
                    class="w-full border rounded px-3 py-2 text-sm" />
                <div *ngIf="f['telefono'].invalid && submitted" class="text-red-500 text-sm">
                    Dirección inválido.
                </div>
            </div>

            <!-- Dirección -->
            <div>
                <label class="block text-sm font-medium">Dirección</label>
                <input type="text" formControlName="direccion" class="w-full border rounded px-3 py-2 text-sm" />
                <div *ngIf="f['direccion'].invalid && submitted" class="text-red-500 text-sm">
                    Dirección inválido.
                </div>
            </div>

            <!-- Botón -->
            <div class="pt-2">
                <button type="submit" class="bg-primary text-white px-4 py-2 rounded w-full disabled:opacity-50">
                    Guardar
                </button>
            </div>
        </form>


    </div>
</div>


<!-- MODAL DE PAGO -->

<div *ngIf="showPaymentModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white w-full max-w-5xl rounded-lg shadow-2xl p-6 relative text-base">
        <!-- Botón cerrar -->
        <button class="absolute top-3 right-4 text-2xl font-bold text-gray-500 hover:text-gray-700"
            (click)="showPaymentModal = false">×</button>

        <h2 class="text-2xl font-bold text-center text-primary mb-6">Finalizar Pedido</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 📦 Columna izquierda: Resumen de productos -->
            <div class="bg-gray-50 rounded-md p-4 border max-h-[70vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">🧾 Detalle del Pedido</h3>

                <div *ngIf="cart.length > 0; else noItems" class="space-y-3 text-sm">
                    <div *ngFor="let item of cart" class="flex justify-between items-center border-b pb-2">
                        <div>
                            <p class="font-medium text-gray-800">{{ item.nombre }} {{item.descripcion?
                                '('+item.descripcion+')' : ''}}</p>
                            <p class="text-gray-600 text-xs">x{{ item.quantity }} • ${{ item.price | number: '1.2-2' }}
                            </p>
                        </div>
                        <p class="font-semibold text-gray-800">${{ item.total | number: '1.2-2' }}</p>
                    </div>
                </div>

                <ng-template #noItems>
                    <p class="text-gray-500 text-sm">No hay productos en el carrito.</p>
                </ng-template>

                <div class="mt-6 border-t pt-4 text-sm space-y-1 text-gray-700">
                    <p><strong>Subtotal:</strong> ${{ subtotal | number: '1.2-2' }}</p>
                    <p><strong>IVA (15%):</strong> ${{ iva | number: '1.2-2' }}</p>
                    <p class="text-base font-bold"><strong>Total:</strong> ${{ total | number: '1.2-2' }}</p>
                </div>
            </div>


            <!-- 💳 Columna derecha: Formulario de pago -->
            <div class="space-y-6">
                <!-- Método de pago -->
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700">Método de Pago</label>
                    <select [(ngModel)]="paymentMethod" (change)="calcularCambio()"
                        class="w-full border border-gray-300 rounded px-4 py-2 text-base focus:outline-none focus:ring-2 focus:ring-primary">
                        <option [value]="item.codigo" *ngFor="let item of payments">{{ item.nombre }}</option>
                    </select>
                </div>

                <!-- Total -->
                <div class="text-center border-y py-4">
                    <p class="text-lg text-gray-600">Total a Pagar</p>
                    <p class="text-4xl font-bold text-green-600">${{ total | number: '1.2-2' }}</p>
                </div>

                <!-- Si es efectivo -->
                <div *ngIf="paymentMethod === '01'" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700">Monto recibido</label>
                        <input type="number" [(ngModel)]="amountReceived" (input)="calcularCambio()"
                            class="w-full border border-gray-300 rounded px-4 py-2 text-xl font-semibold text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary"
                            placeholder="Ingrese monto entregado" />
                    </div>

                    <div class="text-center">
                        <p class="text-lg text-gray-600">Cambio</p>
                        <p class="text-4xl font-bold" [class.text-red-600]="change < 0"
                            [class.text-green-600]="change >= 0">
                            ${{ change | number: '1.2-2' }}
                        </p>
                    </div>
                </div>

                <!-- Confirmar -->
                <div>
                    <button (click)="confirmarPago()"
                        class="w-full py-3 text-xl font-bold bg-primary text-white rounded hover:bg-primary/90 transition">
                        Confirmar y Guardar Orden
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>