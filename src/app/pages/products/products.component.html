<div class="app-container">

  <!-- Header -->
  <div class="app-page-header">
    <div>
      <h2 class="app-page-title">Productos</h2>
      <div class="app-page-subtle space-x-1">
        <span># Registros:</span>
        <span class="text-foreground font-semibold">{{ productosFiltradosList.length || 0 }}</span>
      </div>
    </div>

    <div class="flex gap-2">
      <button class="btn btn-primary" (click)="abrirModal()">+ Nuevo Producto</button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="toolbar">
    <div class="flex gap-2 w-full md:w-auto">
      <input class="input" type="text" [(ngModel)]="searchTerm"
        placeholder="Buscar por nombre o estado (disponible / agotado)..." />
      <select class="select" [(ngModel)]="categoriaFiltro" (ngModelChange)="actualizarProductosFiltrados()">
        <option value="">Todas las categor√≠as</option>
        <option *ngFor="let c of categories" [value]="c.name">{{ c.nombre }}</option>
      </select>
    </div>

    <div class="flex gap-2" (click)="categoriaFiltro=''; searchTerm=''; actualizarProductosFiltrados()">

      <app-button full impact="bold" tone="light" shape="rounded" size="small">
        Limpiar
      </app-button>
    </div>
  </div>

  <!-- Tabla -->
  <ng-container *ngIf="productosFiltradosList?.length; else emptyProducts">
    <div class="app-table-wrap">
      <table class="app-table">
        <thead class="app-thead">
          <tr>
            <th class="app-th">Producto</th>
            <th class="app-th">C√≥digo</th>
            <th class="app-th">Categor√≠a</th>
            <th class="app-th">Impuesto</th>
            <th class="app-th">Precio</th>
            <th class="app-th">Stock</th>
            <th class="app-th">Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr
            *ngFor="let p of productosFiltradosList | paginate: { itemsPerPage: pageSize, currentPage: page }; trackBy: trackByName"
            class="app-tr">

            <td class="app-td">
              <div class="flex flex-col">
                <span class="font-medium text-gray-900">{{ p.nombre }}</span>
                <span class="text-xs text-gray-500">{{ p.descripcion || '' }}</span>
              </div>
            </td>

            <td class="app-td font-mono text-xs text-gray-600">{{ p.codigo || '‚Äî' }}</td>

            <td class="app-td">
              {{ getNameCategory(p.categoria) }}
            </td>

            <td class="app-td">
              <span class="badge badge-gray">{{ p.tax || 'IVA-0' }}</span>
            </td>

            <td class="app-td font-semibold">{{ p.precio | currency }}</td>

            <td class="app-td">
              <span class="badge" [ngClass]="{
                      'badge-green':  !p.is_out_of_stock,
                      'badge-red':    p.is_out_of_stock
                    }">
                {{ p.is_out_of_stock ? 'Agotado' : 'Disponible' }}
              </span>
            </td>

            <td class="app-td">
              <div class="flex gap-2">
                <button class="btn btn-outline" (click)="abrirModal(p)">‚úèÔ∏è Editar</button>
                <button class="btn btn-warn" (click)="eliminar(p.name)">üóëÔ∏è Eliminar</button>
              </div>
            </td>

          </tr>
        </tbody>
      </table>

      <!-- Paginaci√≥n (ngx-pagination) -->
      <div class="pager">
        <button class="pager-btn" (click)="page = page - 1" [disabled]="page === 1">¬´ Anterior</button>
        <span class="text-sm">P√°gina {{ page }}</span>
        <button class="pager-btn" (click)="page = page + 1"
          [disabled]="(productosFiltradosList.length || 0) <= (page * pageSize)">
          Siguiente ¬ª
        </button>
      </div>
    </div>
  </ng-container>

  <ng-template #emptyProducts>
    <div class="app-card">
      <div class="app-card-body text-center text-gray-500">
        No hay productos para mostrar.
      </div>
    </div>
  </ng-template>

  <!-- Modal Crear/Editar -->
  <div *ngIf="mostrarModal" class="app-modal-backdrop">
    <div class="app-modal">
      <button class="app-modal-close" (click)="cerrarModal()">√ó</button>

      <div class="app-card-body">
        <h3 class="text-lg font-semibold mb-4">
          {{ productoEditando ? 'Editar Producto' : 'Nuevo Producto' }}
        </h3>

        <form [formGroup]="productoForm" (ngSubmit)="guardarProducto()" class="grid md:grid-cols-2 gap-4 text-sm">
          <div>
            <label class="block mb-1 font-medium">Nombre</label>
            <input type="text" class="input" formControlName="nombre" />
            <div *ngIf="f['nombre'].touched && f['nombre'].invalid" class="text-red-600 text-xs mt-1">
              Nombre es requerido
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium">C√≥digo</label>
            <input type="text" class="input" formControlName="codigo" />
          </div>

          <div class="md:col-span-2">
            <label class="block mb-1 font-medium">Descripci√≥n</label>
            <textarea rows="3" class="input" formControlName="descripcion"></textarea>
          </div>

          <div>
            <label class="block mb-1 font-medium">Precio</label>
            <input type="number" step="0.01" class="input" formControlName="precio" />
            <div *ngIf="f['precio'].touched && f['precio'].invalid" class="text-red-600 text-xs mt-1">
              Precio inv√°lido
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium">Impuesto</label>
            <select class="select" formControlName="tax">
              <option *ngFor="let t of taxes" [value]="t.name">{{ t.name }}</option>
              <!-- fallback si no llega taxes -->
              <option *ngIf="taxes.length === 0" value="IVA-0" disabled>No hay impuestos disponibles</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 font-medium">Categor√≠a</label>
            <select class="select" formControlName="categoria">
              <option *ngFor="let c of categories" [value]="c.name">{{ c.nombre }}</option>
              <option *ngIf="categories.length === 0" value="" disabled>No hay categor√≠as disponibles</option>
            </select>
            <div *ngIf="f['categoria'].touched && f['categoria'].invalid" class="text-red-600 text-xs mt-1">
              Categor√≠a es requerida
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium">Estado</label>
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" formControlName="isactive" />
                <span>Activo</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" formControlName="is_out_of_stock" />
                <span>Agotado</span>
              </label>
            </div>
          </div>

          <div class="md:col-span-2 flex justify-end gap-2 mt-2">
            <button type="button" class="btn btn-outline" (click)="cerrarModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              {{ productoEditando ? 'Guardar cambios' : 'Crear' }}
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

</div>