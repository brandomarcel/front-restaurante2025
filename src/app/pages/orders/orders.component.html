<div class="flex flex-col">

  <!-- Header -->
  <div class="app-page-header">
    <div>
      <h2 class="app-page-title">√ìrdenes</h2>
      <div class="app-page-subtle space-x-1">
        <span># Registros:</span>
        <span class="text-foreground font-semibold">{{ totalOrders }}</span>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="toolbar">
    <div class="flex flex-col sm:flex-row gap-2 w-full">
      <!-- Texto: N¬∞ orden / cliente / c√©dula / tipo / estado -->
      <input class="input" type="text" [(ngModel)]="searchTerm" (ngModelChange)="actualizarOrdenesFiltradas()"
        placeholder="Buscar por #orden, cliente, c√©dula, tipo o estado SRI..." />

      <!-- Tipo -->
      <select class="select" [(ngModel)]="tipoFiltro" (ngModelChange)="actualizarOrdenesFiltradas()">
        <option value="">Todos los tipos</option>
        <option value="Factura">Factura</option>
        <option value="Nota de venta">Nota de venta</option>
      </select>

      <!-- Anulaci√≥n -->
      <select class="select" [(ngModel)]="anulacionFiltro" (ngModelChange)="actualizarOrdenesFiltradas()">
        <option value="">Todas (incluye anuladas)</option>
        <option value="soloAnuladas">Solo anuladas</option>
        <option value="excluirAnuladas">Excluir anuladas</option>
      </select>
    </div>

    <div class="flex gap-2">
      <app-button (click)="limpiarFiltros()" full impact="bold" tone="light" shape="rounded" size="small">
        Limpiar
      </app-button>
    </div>
  </div>

  <!-- Tabla de √≥rdenes -->
  <ng-container *ngIf="ordersFiltradosList.length > 0; else emptyOrders">
    <div class="app-table-wrap">
      <table class="app-table">
        <thead class="app-thead">
          <tr>
            <th class="app-th">N¬∞ Orden</th>
            <th class="app-th">Fecha</th>
            <th class="app-th">Cliente</th>
            <th class="app-th">IVA</th>
            <th class="app-th">Total</th>
            <th class="app-th">Tipo</th>
            <th class="app-th last:text-center">Estado SRI</th>
            <th class="app-th last:text-center">Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let order of ordersFiltradosList" class="app-tr text-xs">
            <td class="app-td">{{ order.name }}</td>
            <td class="app-td">{{ order.createdAt | date: 'dd/MM/yyyy' }}</td>
            <td class="app-td">
              {{ order.customer?.fullName || order.customer?.name || '‚Äî' }}
            </td>
            <td class="app-td">
              {{ order.iva | currency:'USD':'symbol':'1.2-2' }}
            </td>
            <td class="app-td font-semibold">
              {{ order.total | currency:'USD':'symbol':'1.2-2' }}
            </td>
            <td class="app-td">
              <span class="badge badge-gray">{{ order.type }}</span>
            </td>
            <td class="app-td text-center">
              <span class="badge" [ngClass]="{
                  'badge-green': order.sri?.status === 'AUTORIZADO',
                  'badge-red': order.sri?.status === 'Rejected' || order.sri?.status === 'Error',
                  'badge-yellow': order.sri?.status !== 'AUTORIZADO'
                                   && order.sri?.status !== 'Rejected'
                                   && order.sri?.status !== 'Error'
                }">
                {{
                order.sri?.status === 'AUTORIZADO' ? 'AUTORIZADO' :
                order.sri?.status === 'Rejected' ? 'Rechazada' :
                order.sri?.status === 'Error' ? 'Error' :
                order.sri?.status === 'Queued' ? 'En cola' :
                order.sri?.status === 'Processing'? 'En proceso' :
                order.sri?.status === 'Draft' ? 'Borrador' :
                (order.sri?.status || 'Sin factura')
                }}
              </span>
            </td>

            <td class="app-td text-center">
              <div class="inline-flex gap-2">
                <button class="btn btn-outline" (click)="toggleOrderDetail(order)">
                  üîç Detalle
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      <div class="pager">
        <button class="pager-btn" (click)="prevPage()" [disabled]="page === 1">¬´ Anterior</button>
        <span class="text-sm">P√°gina {{ page }} de {{ totalPages }}</span>
        <button class="pager-btn" (click)="nextPage()" [disabled]="page === totalPages">Siguiente ¬ª</button>
      </div>
    </div>
  </ng-container>

  <ng-template #emptyOrders>
    <div class="app-card">
      <div class="app-card-body text-center text-gray-500">
        No hay √≥rdenes para mostrar.
      </div>
    </div>
  </ng-template>

  <!-- Modal Detalle -->
  <div *ngIf="mostrarModal" class="app-modal-backdrop">
    <div class="app-modal">
      <button class="app-modal-close" (click)="cerrarModal()">√ó</button>

      <div class="app-card-body">
        <h3 class="text-lg font-semibold mb-4">
          Detalle del Pedido #{{ orderSelected?.name }}
        </h3>

        <!-- Botones de acci√≥n -->
        <div class="mb-4 flex flex-wrap gap-2">
          <button class="btn btn-outline" (click)="getComandaPdf()">Imprimir Comanda</button>

          <button *ngIf="orderSelected?.type === 'Nota Venta'" class="btn btn-warn"
            (click)="getNotaVentaPdf()">Descargar Nota</button>

          <button *ngIf="orderSelected?.type !== 'Nota Venta'" class="btn btn-warn" (click)="getFacturaPdf()">Descargar
            Factura</button>

          <button *ngIf="orderSelected?.type === 'Factura' && orderSelected?.sri?.status !== 'AUTORIZADO'"
            class="btn btn-primary" (click)="validarYGenerarFactura()">Reenviar Factura</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab" [ngClass]="{ 'tab-active': activeTab === 'info' }" (click)="activeTab = 'info'">
            Informaci√≥n
          </button>

          <button *ngIf="orderSelected?.type === 'Factura' && orderSelected?.sri" class="tab"
            [ngClass]="{ 'tab-active': activeTab === 'sri' }" (click)="activeTab = 'sri'">
            SRI
          </button>
        </div>

        <!-- Tab: Informaci√≥n -->
        <div *ngIf="activeTab === 'info'">
          <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Informaci√≥n del Pedido -->
            <div>
              <h4 class="text-base font-semibold text-gray-700 mb-2">üßæ Informaci√≥n del Pedido</h4>
              <ul class="text-sm text-gray-700 space-y-1">
                <li><strong>ID:</strong> {{ orderSelected?.name }}</li>
                <li><strong>Tipo:</strong> {{ orderSelected?.type | titlecase }}</li>
                <li><strong>Fecha:</strong> {{ orderSelected?.createdAt | ecuadorTime }}</li>
                <li><strong>Subtotal:</strong> {{ orderSelected?.subtotal | currency:'USD':'symbol':'1.2-2' }}</li>
                <li><strong>IVA:</strong> {{ orderSelected?.iva | currency:'USD':'symbol':'1.2-2' }}</li>
                <li><strong>Total:</strong>
                  <span class="text-green-700 font-semibold">{{ orderSelected?.total | currency:'USD':'symbol':'1.2-2'
                    }}</span>
                </li>
              </ul>
            </div>

            <!-- Cliente -->
            <div>
              <h4 class="text-base font-semibold text-gray-700 mb-2">üë§ Cliente</h4>
              <ul class="text-sm text-gray-700 space-y-1">
                <li><strong>Nombre:</strong> {{ orderSelected?.customer?.nombre || '‚Äî' }}
                </li>
                <li><strong>C√©dula/RUC:</strong> {{ orderSelected?.customer?.num_identificacion || '‚Äî' }}</li>
                <li><strong>Email:</strong> {{ orderSelected?.customer?.correo || '‚Äî' }}</li>
                <li><strong>Tel√©fono:</strong> {{ orderSelected?.customer?.telefono || '‚Äî' }}</li>
                <li><strong>Direcci√≥n:</strong> {{ orderSelected?.customer?.direccion || '‚Äî' }}</li>
              </ul>
            </div>
          </div>

          <!-- Productos del Pedido -->
          <div>
            <h4 class="text-base font-semibold text-gray-700 mb-2">üì¶ Productos del Pedido</h4>
            <div class="overflow-x-auto max-h-[50vh] overflow-y-auto">
              <table class="w-full text-sm border border-gray-200 rounded-lg">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-2 text-left">Producto</th>
                    <th class="p-2 text-left">Cantidad</th>
                    <th class="p-2 text-left">Precio Unitario</th>
                    <th class="p-2 text-left">IVA</th>
                    <th class="p-2 text-left">Subtotal</th>
                    <th class="p-2 text-left">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of orderSelected?.items" class="border-t hover:bg-gray-50">
                    <td class="p-2">{{ item.productName }}</td>
                    <td class="p-2">{{ item.quantity }}</td>
                    <td class="p-2">{{ item.price | currency:'USD':'symbol':'1.2-2' }}</td>
                    <td class="p-2">
                      <span class="badge badge-gray">{{ (item.tax_rate ?? 0) }}%</span>
                    </td>
                    <td class="p-2">{{ (item.subtotal ?? (item.quantity * item.price)) | currency:'USD':'symbol':'1.2-2'
                      }}</td>
                    <td class="p-2 font-medium">
                      {{
                      (item.total ??
                      ((item.subtotal ?? (item.quantity * item.price)) + ((item.subtotal ?? (item.quantity *
                      item.price)) * ((item.tax_rate ?? 0)/100)))
                      ) | currency:'USD':'symbol':'1.2-2'
                      }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab: Info SRI -->
        <div *ngIf="activeTab === 'sri'" class="text-sm text-gray-700">
          <h4 class="text-base font-semibold text-gray-700 mb-2">üì§ Informaci√≥n del SRI</h4>
          <ul class="space-y-1">
            <li><strong>Estado SRI:</strong>
              <span class="badge" [ngClass]="{
                  'badge-green': orderSelected?.sri?.status === 'AUTORIZADO',
                  'badge-red': orderSelected?.sri?.status === 'Rejected' || orderSelected?.sri?.status === 'Error',
                  'badge-yellow': orderSelected?.sri?.status !== 'AUTORIZADO'
                                   && orderSelected?.sri?.status !== 'Rejected'
                                   && orderSelected?.sri?.status !== 'Error'
                }">
                {{
                orderSelected?.sri?.status === 'AUTORIZADO' ? 'AUTORIZADO' :
                orderSelected?.sri?.status === 'Rejected' ? 'Rechazada' :
                orderSelected?.sri?.status === 'Error' ? 'Error' :
                orderSelected?.sri?.status === 'Queued' ? 'En cola' :
                orderSelected?.sri?.status === 'Processing'? 'En proceso' :
                orderSelected?.sri?.status === 'Draft' ? 'Borrador' :
                (orderSelected?.sri?.status || 'Sin factura')
                }}
              </span>
            </li>

            <li *ngIf="orderSelected?.sri?.number"><strong>N√∫mero:</strong> {{ orderSelected.sri.number }}</li>
            <li *ngIf="orderSelected?.sri?.invoice"><strong>Factura:</strong> {{ orderSelected.sri.invoice }}</li>
            <li *ngIf="orderSelected?.sri?.grand_total !== undefined">
              <strong>Total Factura:</strong> {{ orderSelected.sri.grand_total | currency:'USD':'symbol':'1.2-2' }}
            </li>
            <li *ngIf="orderSelected?.sri?.access_key">
              <strong>Clave de Acceso:</strong>
              <span class="break-all font-mono text-sm text-blue-700">{{ orderSelected.sri.access_key }}</span>
            </li>
            <li *ngIf="orderSelected?.sri?.authorization_datetime">
              <strong>F. Autorizaci√≥n:</strong> {{ orderSelected.sri.authorization_datetime }}
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>

</div>