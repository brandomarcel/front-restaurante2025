<div #topAnchor></div>

<!-- barra sticky con contador -->
<div class="sticky top-0  bg-white/80 backdrop-blur border-b border-gray-200 px-4 py-2 flex items-center justify-between">
  <div>
    <h2 class="text-lg font-semibold">Ã“rdenes en tiempo real</h2>
    <p class="text-xs text-gray-500">Se actualiza automÃ¡ticamente cuando se crean o cambian Ã³rdenes.</p>
  </div>

  <button
    *ngIf="newCount > 0"
    (click)="scrollToTop()"
    class="ml-3 inline-flex items-center gap-2 rounded-full bg-emerald-600 text-white text-sm px-3 py-1.5 shadow hover:bg-emerald-700 active:bg-emerald-800 transition"
    aria-label="Ver nuevas Ã³rdenes">
    <span class="h-2 w-2 rounded-full bg-white animate-ping"></span>
    {{ newCount }} nueva{{ newCount>1?'s':'' }}
  </button>
</div>

<!-- filtros -->
<div class="px-4 py-3 flex flex-col sm:flex-row gap-2 sm:items-center">
  <input type="text" placeholder="Buscar por cliente o #ordenâ€¦" class="w-full sm:w-72 rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" [(ngModel)]="search" />
  <select class="w-full sm:w-48 rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" [(ngModel)]="tipo">
    <option value="">Todos los tipos</option>
    <option>Factura</option>
    <option>Nota Venta</option>
  </select>
</div>

<!-- mÃ³vil: cards -->
<div class="px-4 grid grid-cols-1 gap-3 md:hidden">
  <div *ngFor="let o of orders | slice:0:100 | orderRealtimeFilter:search:tipo; trackBy: trackByName"
       class="rounded-lg border border-gray-200 bg-white p-3 shadow-sm"
       [class.ring-2]="o._flash" [class.ring-emerald-400]="o._flash">

    <div class="flex items-center justify-between mb-1">
      <div class="text-xs text-gray-500">#{{ o.name }}</div>
      <span class="text-[10px] px-2 py-0.5 rounded-full"
            [ngClass]="{
              'bg-emerald-100 text-emerald-700': o.type==='Factura',
              'bg-amber-100 text-amber-700': o.type==='Nota Venta',
              'bg-gray-100 text-gray-700': o.type!=='Factura' && o.type!=='Nota Venta'
            }">{{ o.type || 'â€”' }}</span>
    </div>

    <div class="flex items-baseline justify-between">
      <div class="font-semibold text-gray-900 truncate">
        {{ getCustomerName(o) }}
      </div>
      <div class="text-right">
        <div class="text-base font-bold text-gray-900">{{ o.total | currency:'USD':'symbol':'1.2-2' }}</div>
        <div class="text-[11px] text-gray-500">IVA: {{ o.iva || 0 | number:'1.2-2' }}</div>
      </div>
    </div>

    <div class="mt-2 flex items-center justify-between text-[11px] text-gray-500">
      <div class="truncate">Estado: <span class="font-medium text-gray-700">{{ o.sri?.status || 'â€”' }}</span></div>
      <div>{{ o.createdAt | date:'dd/MM, HH:mm' }}</div>
    </div>

    <div class="mt-3 flex gap-2">
      <a [routerLink]="['/dashboard/orders', o.name]" class="inline-flex items-center justify-center rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50">ðŸ”Ž Abrir</a>
    </div>
  </div>
</div>

<!-- desktop: tabla -->
<div class="hidden md:block px-4">
  <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-gray-600">
        <tr>
          <th class="px-4 py-2 text-left">NÂ° Orden</th>
          <th class="px-4 py-2 text-left">Fecha</th>
          <th class="px-4 py-2 text-left">Cliente</th>
          <th class="px-4 py-2 text-right">IVA</th>
          <th class="px-4 py-2 text-right">Total</th>
          <th class="px-4 py-2 text-left">Tipo</th>
          <th class="px-4 py-2 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of orders | slice:0:100 | orderRealtimeFilter:search:tipo; trackBy: trackByName"
            class="border-t"
            [class.animate-pulse]="o._flash">
          <td class="px-4 py-2 align-top font-medium text-gray-900">#{{ o.name }}</td>
          <td class="px-4 py-2 align-top text-gray-700">{{ o.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
          <td class="px-4 py-2 align-top text-gray-900">
            {{ getCustomerName(o) }}
          </td>
          <td class="px-4 py-2 align-top text-right text-gray-700">{{ o.iva || 0 | number:'1.2-2' }}</td>
          <td class="px-4 py-2 align-top text-right font-semibold text-gray-900">{{ o.total | currency:'USD':'symbol':'1.2-2' }}</td>
          <td class="px-4 py-2 align-top">
            <span class="text-[11px] px-2 py-0.5 rounded-full"
              [ngClass]="{
                'bg-emerald-100 text-emerald-700': o.type==='Factura',
                'bg-amber-100 text-amber-700': o.type==='Nota Venta',
                'bg-gray-100 text-gray-700': o.type!=='Factura' && o.type!=='Nota Venta'
              }">{{ o.type || 'â€”' }}</span>
          </td>
          <td class="px-4 py-2 align-top text-center">
            <a [routerLink]="['/dashboard/orders', o.name]" class="inline-flex items-center justify-center rounded-md border border-gray-300 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50">ðŸ”Ž Abrir</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
